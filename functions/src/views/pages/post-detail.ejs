<!DOCTYPE html>
<html>

<head>
  <%- include('../partials/head'); %>

    <script src="/javascripts/gMapKey.js?ver=2023122001332"></script>
    <!-- prettier-ignore -->
    <script>(g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })
        ({ key: GMAP_KEY, v: "weekly" });</script>
    <script src="/javascripts/tslDef.js?ver=2023122001332"></script>
    <script>
      var targetPost = JSON.parse('<%- JSON.stringify(post) %>');
    </script>
    <script src="/javascripts/tslGMapUtil.js?ver=2023122001332"></script>
    <script src="/javascripts/renderPostOnGMap.js?ver=2023122001332"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
</head>

<body>
  <div class="flex flex-col" style="min-height: 100svh; max-height: 100svh;">
    <%- include('../partials/header', {showBack2: showBack}); %>
      <!-- Main Body -->
      <div class="grow overflow-y-scroll">
        <img width="100%" height="80px" src="<%= post.imageUrl %>" style="border: 1px solid; " />
        <div class="p-2">
          <div style="display:flex; justify-content:space-between;">
            <div style="display:flex;">
              <img width="40px" height="40px" src="<%= post.user.iconUrl %>"
                style="border: 2px solid #ff0099; border-radius:50%" />
              <span style="font-weight:bold; font-family:Kaisai Decol; color:#ff0099; padding-left:10px;">
                <%= post.user.userName %>
              </span>
            </div>
            <span style="font-size: small; margin-left:20px;">
              <%= post.insertDate.toLocaleString("ja-JP") %>
            </span>
          </div>
          <div>
            <input type="button" class="mt-3 btn text-white bg-accent" style="background-color:#ff0099;"
              value="Xでシェアする" />
            <button class="mt-3 btn text-white bg-accent" style="background-color:#ff0099;" onclick="return deletePost();">削除</button>
            <script>
              function deletePost() {
                if (!(confirm('本当に削除して良いですか？'))) {
                  return;
                }

                fetch('/post/<%= post.id %>', {
                  method: 'DELETE',
                }).then((response) => { 
                  window.location = '/new-posts?deletedToast=true';
                }).catch((error) => {
                  console.error(error);
                  window.location = '/500';
                })
              }
            </script>
          </div>
          <p class="w-full break-words">
            <%= post.description %>
          </p>
        </div>
        <div class="flex justify-center items-center">
          <div id="map" class="w-[90%] h-[200px] border"></div>
        </div>
        <% for (const comment of post.postComments) { %>
          <hr />
          <div class="w-full px-4 py-2">
            <div style="display:flex; justify-content:space-between;">
              <div style="display:flex;">
                <img width="40px" height="40px" src="<%= comment.user.iconUrl %>"
                  style="border: 2px solid #ff0099; border-radius:50%" />
                <span style="font-weight:bold; font-family:Kaisai Decol; color:#ff0099; padding-left:10px;">
                  <%= comment.user.userName %>
                </span>
              </div>
              <span style="font-size: small; margin-left:20px;">
                <%= comment.commentDate.toLocaleString("ja-JP") %>
              </span>
            </div>
            <p class="w-full break-words">
              <%= comment.comment %>
            </p>
          </div>
          <% } %>
      </div>
      <%- include('../partials/footer', {currentMenu: 2}); %>

  </div>
</body>

</html>